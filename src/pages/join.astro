---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout
  title="Join a Chapter | Crown and Compass"
  description="Crown and Compass is free. No application. No commitment. Show up on a Saturday morning and see what happens."
>

  <link
    slot="head"
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Page Hero -->
  <section class="join-hero">
    <div class="section-container">
      <p class="label-flanked">Join a Chapter</p>
      <div class="rule-heraldic"></div>
      <h1 class="join-headline">Show up once.<br />See what happens.</h1>
      <p class="join-subtext">
        There is no application. No commitment required for the first visit. A man comes once,
        sits in the room, and decides for himself.
      </p>
    </div>
  </section>

  <!-- Chapter Map -->
  <section class="map-section">
    <div class="section-container">
      <p class="label-flanked">Where We Meet</p>
      <div class="chapter-list">
        <span class="chapter-tag">Mint Hill, NC</span>
        <span class="chapter-tag">Mount Holly, NC</span>
        <span class="chapter-tag">Concord, NC</span>
        <span class="chapter-tag">Summerville, SC</span>
      </div>
    </div>
    <div id="chapter-map"></div>
  </section>

  <!-- Main Content -->
  <div class="section-pad">
    <div class="section-container join-layout">

      <!-- Left: What joining looks like + cost -->
      <div class="join-info">

        <div class="info-block">
          <h2 class="info-heading">What joining looks like</h2>
          <p>
            The current Chapter meets on Saturday mornings at 7am. Brian Guides the first session
            for any new Brother. You read the assigned section of the current book beforehand —
            that's the only preparation required.
          </p>
          <p>
            The meeting has structure: discussion of the book, then The Round. Three moves:
            a check-in (<em>where are you, really?</em>), The Ask (prayer and accountability),
            and The Close (a verse or a thought to carry into the week). It runs about an hour.
          </p>
          <p>
            You do not need to perform. You do not need to have your life together. You need
            a willingness to show up and say something true. That's the whole requirement.
          </p>
        </div>

        <div class="info-block">
          <h2 class="info-heading">What it costs</h2>
          <div class="free-callout crest-corners">
            <p class="free-text">Nothing.</p>
            <p class="free-sub">
              Crown and Compass is free because the Gospel is free, and because the best
              communities — F3, AA, the early church — have never charged for belonging.
              A man doesn't pay to belong here. He belongs because he shows up.
            </p>
          </div>
        </div>

        <div class="info-block">
          <h2 class="info-heading">The current book</h2>
          <p>
            Every Chapter reads the same book at the same time. The book is the common ground
            that makes honest conversation possible. Without it, men default to small talk or
            complaint. With it, they have a shared text to push against: to agree with,
            to argue with, to hold up as a mirror.
          </p>
          <p>
            Reach out to find out what we're reading now and where to get a copy.
          </p>
        </div>

      </div>

      <!-- Right: Form -->
      <div class="join-form-col">
        <div class="form-card">
          <h2 class="form-heading">Get connected</h2>
          <p class="form-subtext">
            Fill this out and Brian will be in touch within a day or two. No pressure.
            Just a conversation.
          </p>

          <div id="form-wrap">
            <form
              id="join-form"
              action="/api/join"
              method="POST"
              class="cc-form"
            >
              <div class="field-group">
                <label for="name" class="field-label">Name</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  required
                  placeholder="Your name"
                  class="field-input"
                />
              </div>

              <div class="field-group">
                <label for="email" class="field-label">Email</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  placeholder="you@example.com"
                  class="field-input"
                />
              </div>

              <div class="field-group">
                <label for="how" class="field-label">How did you hear about Crown and Compass?</label>
                <textarea
                  id="how"
                  name="how_you_heard"
                  rows="3"
                  placeholder="A friend, word of mouth, just found it..."
                  class="field-input field-textarea"
                ></textarea>
              </div>

              <div class="field-group">
                <label for="message" class="field-label">Anything else you want Brian to know? <span class="optional">(optional)</span></label>
                <textarea
                  id="message"
                  name="message"
                  rows="4"
                  placeholder="Where you're at, what you're looking for, questions you have..."
                  class="field-input field-textarea"
                ></textarea>
              </div>

              <div id="form-error" class="form-error" style="display:none"></div>

              <button type="submit" id="submit-btn" class="btn-amber submit-btn">
                Send it
              </button>

              <p class="form-note">
                Brian reads every message personally. You'll hear from him, not an autoresponder.
              </p>
            </form>
          </div>

          <script>
            const form = document.getElementById('join-form') as HTMLFormElement;
            const formWrap = document.getElementById('form-wrap') as HTMLDivElement;
            const errorEl = document.getElementById('form-error') as HTMLDivElement;
            const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

            form.addEventListener('submit', async (e) => {
              e.preventDefault();
              errorEl.style.display = 'none';
              submitBtn.disabled = true;
              submitBtn.textContent = 'Sending...';

              const data = {
                name: (form.querySelector('#name') as HTMLInputElement).value,
                email: (form.querySelector('#email') as HTMLInputElement).value,
                how_you_heard: (form.querySelector('#how') as HTMLTextAreaElement).value,
                message: (form.querySelector('#message') as HTMLTextAreaElement).value,
              };

              try {
                const res = await fetch('/api/join', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data),
                });
                const json = await res.json() as { success?: boolean; error?: string };

                if (json.success) {
                  formWrap.innerHTML = `
                    <div class="success-message">
                      <p class="success-headline">Good.</p>
                      <p class="success-body">Brian will reach out soon. In the meantime, keep walking.</p>
                    </div>
                  `;
                } else {
                  errorEl.textContent = json.error || 'Something went wrong. Try again.';
                  errorEl.style.display = 'block';
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'Send it';
                }
              } catch {
                errorEl.textContent = 'Something went wrong. Try again.';
                errorEl.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send it';
              }
            });
          </script>
        </div>

        <!-- Alternative contact -->
        <div class="alt-contact">
          <p class="alt-label">Or reach out directly</p>
          <p class="alt-text">
            If forms aren't your thing, find Brian at
            <a href="https://x.com/realjbmangum" target="_blank" rel="noopener noreferrer" class="alt-link">
              @realjbmangum
            </a>
            on X (Twitter). A direct message works fine.
          </p>
        </div>

      </div>

    </div>
  </div>

</BaseLayout>

<style>
  /* Hero */
  .join-hero {
    padding: 5rem 1.5rem 3rem;
    border-bottom: 1px solid var(--border);
  }

  .overline {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.6875rem;
    font-weight: 500;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--accent);
    margin: 0 0 0.75rem;
  }

  .join-headline {
    font-family: 'EB Garamond', Georgia, serif;
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1.15;
    margin: 0 0 1rem;
  }

  .join-subtext {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 1rem;
    color: var(--text-muted);
    font-weight: 300;
    line-height: 1.7;
    margin: 0;
    max-width: 38rem;
  }

  /* Layout */
  .join-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 4rem;
    align-items: start;
  }

  @media (min-width: 900px) {
    .join-layout {
      grid-template-columns: 1fr 22rem;
    }
  }

  /* Info blocks */
  .info-block {
    margin-bottom: 3rem;
  }

  .info-block:last-child {
    margin-bottom: 0;
  }

  .info-heading {
    font-family: 'EB Garamond', Georgia, serif;
    font-size: 1.375rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 1rem;
  }

  .info-block p {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.9375rem;
    color: var(--text-muted);
    font-weight: 300;
    line-height: 1.75;
    margin-bottom: 1rem;
  }

  .info-block p:last-child {
    margin-bottom: 0;
  }

  /* Free callout */
  .free-callout {
    border-left: 3px solid var(--accent);
    padding: 0.25rem 0 0.25rem 1.5rem;
  }

  .free-text {
    font-family: 'EB Garamond', Georgia, serif;
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 0.75rem !important;
  }

  .free-sub {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.9375rem;
    color: var(--text-muted) !important;
    font-weight: 300;
    line-height: 1.7;
  }

  /* Form card */
  .form-card {
    background-color: var(--bg-card);
    border: 1px solid var(--accent);
    outline: 1px solid rgba(201, 133, 58, 0.2);
    outline-offset: -6px;
    padding: 2rem;
  }

  .form-heading {
    font-family: 'EB Garamond', Georgia, serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 0.5rem;
  }

  .form-subtext {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.875rem;
    color: var(--text-muted);
    font-weight: 300;
    line-height: 1.6;
    margin: 0 0 1.75rem;
  }

  /* Form fields */
  .cc-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .field-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .field-label {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--text-primary);
    letter-spacing: 0.02em;
  }

  .optional {
    color: var(--text-muted);
    font-weight: 300;
  }

  .field-input {
    background-color: var(--bg-surface);
    border: 1px solid var(--border);
    color: var(--text-primary);
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.9375rem;
    font-weight: 300;
    padding: 0.625rem 0.875rem;
    border-radius: 2px;
    outline: none;
    width: 100%;
    transition: border-color 0.15s ease;
  }

  .field-input::placeholder {
    color: var(--text-muted);
    opacity: 0.5;
  }

  .field-input:focus {
    border-color: var(--accent);
  }

  .field-textarea {
    resize: vertical;
    min-height: 80px;
    line-height: 1.6;
  }

  .submit-btn {
    width: 100%;
    text-align: center;
    padding: 0.8125rem 1.5rem;
    font-size: 1rem;
    cursor: pointer;
    margin-top: 0.25rem;
  }

  .form-note {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.8125rem;
    color: var(--text-muted);
    font-weight: 300;
    line-height: 1.6;
    margin: 0;
    text-align: center;
    opacity: 0.7;
  }

  /* Alt contact */
  .alt-contact {
    margin-top: 1.5rem;
    padding: 1.25rem;
    border: none;
    border-top: 2px solid var(--accent);
    border-left: 1px solid rgba(201, 133, 58, 0.2);
    border-right: 1px solid rgba(201, 133, 58, 0.2);
    border-bottom: 1px solid var(--border);
  }

  .alt-label {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.6875rem;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent);
    margin: 0 0 0.5rem;
  }

  .alt-text {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.875rem;
    color: var(--text-muted);
    font-weight: 300;
    line-height: 1.6;
    margin: 0;
  }

  .alt-link {
    color: var(--accent);
    text-decoration: none;
    transition: color 0.15s ease;
  }

  .alt-link:hover {
    color: var(--accent-light);
    text-decoration: underline;
  }

  /* Form error */
  .form-error {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.875rem;
    color: #e07070;
    background-color: rgba(224, 112, 112, 0.08);
    border: 1px solid rgba(224, 112, 112, 0.25);
    padding: 0.625rem 0.875rem;
    border-radius: 2px;
  }

  /* Success state */
  .success-message {
    padding: 2rem 0;
    text-align: center;
  }

  .success-headline {
    font-family: 'EB Garamond', Georgia, serif;
    font-size: 3rem;
    font-weight: 700;
    color: var(--accent);
    margin: 0 0 0.75rem;
  }

  .success-body {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 1rem;
    font-weight: 300;
    color: var(--text-muted);
    line-height: 1.7;
    margin: 0;
  }

  @media (min-width: 900px) {
    .join-form-col {
      position: sticky;
      top: 5rem;
    }
  }

  /* ----------------------------------------
     Chapter Map
  ---------------------------------------- */
  .map-section {
    padding: 3rem 0 0;
    border-top: 1px solid var(--border);
  }

  .map-section .section-container {
    padding-bottom: 1.25rem;
  }

  .chapter-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.625rem;
    margin-top: 0.75rem;
  }

  .chapter-tag {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 0.875rem;
    font-weight: 400;
    color: var(--text-muted);
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 0.3125rem 0.75rem;
    border-radius: 1px;
  }

  #chapter-map {
    height: 420px;
    width: 100%;
    background: var(--bg-card);
  }

  @media (max-width: 640px) {
    #chapter-map {
      height: 300px;
    }
  }

  /* Leaflet overrides — dark theme */
  :global(.leaflet-container) {
    background: #0f1117;
    font-family: 'DM Sans', system-ui, sans-serif;
  }

  :global(.leaflet-tile-pane) {
    opacity: 0.9;
  }

  :global(.leaflet-popup-content-wrapper) {
    background: #1a1a20;
    border: 1px solid #c9853a;
    border-radius: 2px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.6);
    color: #f0ebe2;
  }

  :global(.leaflet-popup-tip) {
    background: #c9853a;
  }

  :global(.leaflet-popup-content) {
    margin: 0.75rem 1rem;
  }

  :global(.leaflet-popup-close-button) {
    color: #8a8070 !important;
  }

  :global(.cc-marker-wrap) {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  :global(.cc-marker-pin) {
    width: 14px;
    height: 14px;
    background: #c9853a;
    border-radius: 50%;
    border: 2px solid rgba(201, 133, 58, 0.4);
    box-shadow: 0 0 0 4px rgba(201, 133, 58, 0.15);
  }
</style>

<script>
  // Leaflet map — load async after page ready
  async function initMap() {
    // @ts-ignore
    const L = (await import('https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js')).default ?? (await import('https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js'));

    const chapters = [
      { name: 'Mint Hill Chapter',    city: 'Mint Hill, NC',    lat: 35.1765, lng: -80.6459 },
      { name: 'Mount Holly Chapter',  city: 'Mount Holly, NC',  lat: 35.2993, lng: -81.0159 },
      { name: 'Concord Chapter',      city: 'Concord, NC',      lat: 35.4088, lng: -80.5796 },
      { name: 'Summerville Chapter',  city: 'Summerville, SC',  lat: 33.0185, lng: -80.1754 },
    ];

    const map = L.map('chapter-map', {
      center: [34.3, -80.72],
      zoom: 7,
      zoomControl: true,
      scrollWheelZoom: false,
      attributionControl: true,
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_matter/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19,
    }).addTo(map);

    const markerIcon = L.divIcon({
      className: 'cc-marker-wrap',
      html: '<div class="cc-marker-pin"></div>',
      iconSize: [22, 22],
      iconAnchor: [11, 11],
      popupAnchor: [0, -14],
    });

    chapters.forEach(ch => {
      L.marker([ch.lat, ch.lng], { icon: markerIcon })
        .addTo(map)
        .bindPopup(`
          <p style="font-family:'EB Garamond',serif;font-size:1.0625rem;font-weight:600;color:#f0ebe2;margin:0 0 2px;">${ch.name}</p>
          <p style="font-family:'DM Sans',sans-serif;font-size:0.8125rem;color:#8a8070;margin:0;">${ch.city}</p>
        `);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
  } else {
    initMap();
  }
</script>
